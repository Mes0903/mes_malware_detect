/**
 * @file training_ball.cpp
 * @author Mes (mes900903@gmail.com) (Discord: Mes#0903)
 * @brief Traning the Adaboost to classified if an object is an ball, then stored the weighting.
 *        Execute it by command `rosrun mes_detect_ball Training_Ball` if you use ROS to build it.
 * @version 0.1
 * @date 2022-11-17
 */

#include "adaboost.h"
#include "logistic.h"
#include "normalize.h"
#include "file_handler.h"
#include "feature_num.h"
#include "Eigen/Dense"

#include <filesystem>
#include <iostream>
#include <limits>

int main()
{
  namespace fs = std::filesystem;

  const fs::path top(FileHandler::get_filepath());
  const fs::path files(top / "files");

  int case_num = 0;
  int sample = 0;

  std::cout << "Input 1 if training, others if loading\n>";
  std::cin >> case_num;

  if (case_num == 1) {
    std::cout << "input sample numbers\n>";
    std::cin >> sample;
  }
  std::cin.clear();
  std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n');

  puts("read training data...");
  auto [train_X, train_Y] = LoadMatrix::readDataSet(files, "train", 5432);

  puts("reading testing data...");
  auto [test_X, test_Y] = LoadMatrix::readDataSet(files, "test", 5436);

  if (case_num == 1) {
    /* fitting */

    Normalizer normalizer;
    normalizer.fit(train_X);
    train_X = normalizer.transform(train_X);
    test_X = normalizer.transform(test_X);

    for (int i = 0; i < sample; ++i) {
      std::cout << "========================================================================================\n";
      std::cout << "training sample " << i + 1 << "...\n";
      puts("start tranning");
      Adaboost<logistic> A(100);
      A.fit(train_X, train_Y);

      // prediction
      puts("make prediction");
      Eigen::VectorXd pred_Y = A.predict(test_X);

      puts("cal confusion matrix");
      Eigen::MatrixXd confusion_matrix = metric::cal_confusion_matrix(test_Y, pred_Y);
      A.set_confusion_matrix(confusion_matrix);
      A.print_confusion_matrix();

      FileHandler::store_weight(confusion_matrix, filepath + "/dataset/weight_data/adaboost_ball_weight.txt", A, normalizer);
    }
  }
  else {
    Normalizer normalizer;
    Adaboost<logistic> A;

    puts("Load Weighting...");
    FileHandler::load_weight(filepath + "/dataset/weight_data/adaboost_ball_weight.txt", A, normalizer);

    puts("Transforming test data...");
    test_X = normalizer.transform(test_X);

    puts("make prediction");
    Eigen::VectorXd pred_Y = A.predict(test_X);

    puts("cal confusion matrix");
    A.set_confusion_matrix(metric::cal_confusion_matrix(test_Y, pred_Y));
    A.print_confusion_matrix();
  }
}